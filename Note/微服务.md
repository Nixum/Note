[TOC]

# 负载均衡

## 常用算法

- 轮询：按请求的顺序分配给各个服务器，适用于各台服务器性能相同
- 加权轮询：给各个服务器附上权重值，按权重的高低分配请求，适用于各台服务器性能不同，性能高的服务器权重也高
- 加权随机轮询：随机 + 二分查找的方式负载均衡，时间复杂度为O(logn)
- 最少链接：将请求发送给当前最少连接数的服务器上
- 加权最少链接：在最少连接的基础上，根据服务器的性能为每台服务器分配权重，再根据权重计算出每台服务器能处理的连接数
- IP地址哈希：哈希均匀分布
- 二次随机选择轮询：适合后端节点权重一致的情况，通过两次随机算法，获取到两个节点，对比节点CPU等信息，选择最优节点；（比较流行）
- 会话保持：根据客户端IP或cookie进行会话保持，同一个客户端每次选取后端节点的IP保持一致，适用于节点保持登录验证会话的场景，比较少用。

## 探活

负载均衡器上面一般会挂一个服务的多个复制集，进行流量的负载均衡，因此需要检查这多个复制集的健康情况，保证流量能正确路由到可用节点上。

### 主动健康检查

设定一定时间间隔内对各个复制集执行ping操作，一般在获取节点数量过少的场景下才触发，避免长时间频繁的ping操作增加节点负担。

比如通过当前节点数与15分钟前的节点数的比较，当小于80%时触发主动健康检查。

### 被动健康检查

通过检查节点真实流量的响应结果，判断节点是否正常

# 服务注册与发现

## 基本功能

1. 提供服务地址与域名的映射注册、查找和更新

2. 提供多种负载均衡方案

3. 健康检查，比如心跳检测

   * **服务主动探活**：服务注册到注册中心后，定时发送续租请求到注册中心，表明自己存活

     优点：该方案可最大程度**避免IP重用**导致节点在旧服务依然存活的问题(比如k8s环境)

     缺点：造成注册中心写操作变多，特别是在强一致性的注册中心上，频繁的节点变更会导致产生大量的通知事件，在同步到多个注册中心复制集时性能不佳；另外，仍然可能发生服务虽无法对外提供服务了，但仍然可以发送续租请求；面对不同的客户端需要提供不同语言的SDK

   * **注册中心主动探活**：服务提供健康检查接口，比如/ping，注册中心定时访问验证节点存活；k8s的Pod探针机制

     优点：一定程度上解决服务主动探活不能说明服务健康的问题

     缺点：IP重用问题，比如A、B两个服务都有相同的端口和/ping接口做健康检查，但是当发生服务替换时，无法区分是哪个服务，除非加上名称检查

   * 服务外挂一个负载均衡器实现服务探活、与注册中心的通信

     优点：注册中心和服务均不需要主动探活，均交由负载均衡器实现

     缺点：需要外挂的负载均衡器，增加成本

4. 注册中心需要保证CP或者AP

5. 将上述功能包装成SDK，简化使用

## 可能遇到的问题

1. 注册中心故障时，服务注册功能失效，服务也无法执行扩容操作，因此会在服务内缓存服务注册表，保证服务可通信；
2. 优先使用缓存的服务注册表，当接收到的服务注册表的节点过少时，放弃使用；
3. 通过在负载均衡器中加入被动健康检查和主动健康检查来剔除服务注册表中失效的节点，保证服务注册表的可用性
4. 参考Service Mesh的Envoy设计，不完全信任注册中心推送过来的服务注册表；

| 发现状态 | 健康检查成功 | 健康检查失败         |
| -------- | ------------ | -------------------- |
| 发现     | 路由         | 不路由               |
| 未发现   | 路由         | 不路由、剔除失败节点 |

5. 面对节点和服务频繁变更，导致广播风暴的场景，可以通过合并设定时间内产生的消息后再进行推送，目的是为了减少广播次数，但是这样会影响消息的时效性，要注意设定的时间不宜过长。

## 常见的注册中心区别

| 特征           | Nocas                         | Eureka | Zookeeper  | Consul               | ETCD   |
| -------------- | ----------------------------- | ------ | ---------- | -------------------- | ------ |
| 一致性协议     | AP或CP                        | AP     | CP         | CP                   | CP     |
| 健康检查       | TCP、HTTP、MySQL、Client Beat | TTL    | Keep Alive | TCP、HTTP、gRPC、Cmd | TTL    |
| 网络异常保护   | 支持                          | 支持   | 不支持     | 支持                 | 不支持 |
| 雪崩保护       | 支持                          | 支持   | 不支持     | 不支持               | 不支持 |
| 自动注销实例   | 支持                          | 支持   | 支持       | 不支持               | 支持   |
| 访问协议       | HTTP、DNS                     | HTTP   | TCP        | HTTP、DNS            | HTTP   |
| 跨注册中心同步 | 支持                          | 不支持 | 不支持     | 支持                 | 不支持 |
| K8s集成        | 支持                          | 不支持 | 不支持     | 支持                 | 支持   |
| 语言实现       | Java                          | Java   | Java       | GO                   | GO     |

一般来说，注册中心对一致性的要求不是很高，因为节点的注册和反注册后通知到客户端也需要时间；对可用性的优先级较高。

这里再说下K8s提供的默认服务发现（1.12后默认使用coreDNS），通过为Pod挂一个Service 或者 Pod 定义了hostname + subdomain，k8s也会为其生成Pod的 DNS A记录，然后 k8s 会把 Service 或 Pod 产生的DNS记录写入 CoreDNS 的 cache 或者 ETCD 中，同时在Pod的/etc/resolv.conf文件中添加CoreDNS服务的访问配置，Pod即可通过名称进行访问（同一命名空间下可以直接使用Pod名称进行访问，不同命名空间需要 Pod名称.命名空间名称 访问，或者直接使用Service的DNS名称访问）。

CoreDNS会监听集群内所有Service API，当服务不可用时移除记录，在新服务创建时插入新记录，这些记录会存储在CoreDNS的cache或者ETCD中。

参考：https://github.com/kubernetes/dns/blob/master/docs/specification.md

比如有如下 /etc/resolv.conf文件

```sh
# /etc/resolv.conf
nameserver 10.100.0.10  # coreDNS的IP
search cafe.svc.cluster.local svc.cluster.local cluster.local us-west-2.compute.internal
options ndots:5
```

其含义是：DNS 服务器为 10.100.0.10，当查询关键词中 `.` 的数量少于 5 个，则根据 search 中配置的域名进行查询，当查询都没有返回正确响应时再尝试直接查询关键词本身。

比如执行 host -v cn.bing.com 时会看到下面即此查询

```sh
Trying "cn.bing.com.cafe.svc.cluster.local"
Trying "cn.bing.com.svc.cluster.local"
Trying "cn.bing.com.cluster.local"
Trying "cn.bing.com.us-west-2.compute.internal"
Trying "cn.bing.com"
...
```

# 